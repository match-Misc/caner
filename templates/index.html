{% extends "base.html" %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="filter-panel">
            <form action="/" method="get" class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label for="date" class="form-label">Datum</label>
                    <input type="text" name="date" id="date" class="form-control" value="{{ selected_date }}" readonly>
                </div>
                <div class="col-md-6">
                    <label for="mensa" class="form-label">Mensa</label>
                    <select name="mensa" id="mensa" class="form-select" onchange="this.form.submit()">
                        {% for mensa in available_mensen %}
                            <option value="{{ mensa }}" {% if mensa == selected_mensa %}selected{% endif %}>
                                {{ mensa }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
            <!-- Removed Expert Mode Toggle Checkbox -->
        </div>
    </div>
</div>

{% if data %}
    {% for mensa, meals in data.items() %}
        <div class="mensa-section mb-4">
            <h2 class="mensa-title d-flex align-items-center">
                {% if mensa == selected_mensa %}
                    <a href="#" role="button" class="btn btn-sm btn-outline-secondary me-2 date-nav-arrow" data-direction="prev" title="Vorheriger Tag"><i class="fas fa-chevron-left"></i></a>
                {% endif %}

                <span class="mensa-name-text">{{ mensa }}</span> {# Mensa name #}

                {% if mensa == selected_mensa %}
                    <a href="#" role="button" class="btn btn-sm btn-outline-secondary ms-2 date-nav-arrow" data-direction="next" title="Nächster Tag"><i class="fas fa-chevron-right"></i></a>
                {% endif %}

                {# Emojis - adjusted margin based on presence of next button #}
                <span class="ms-2">
                    {% if mensa == "Mensa Garbsen" %}
                        <span id="askMarvinEmojiTrigger" style="cursor: pointer;" title="Frag Marvin zu Mensa Garbsen & XXXLutz">{{ mensa_emojis[mensa] }}</span>
                    {% elif mensa == "Hauptmensa" %}
                        <span id="askBobEmojiTrigger" style="cursor: pointer;" title="Frag Bob der Baumeister zur Hauptmensa">{{ mensa_emojis[mensa] }}</span>
                    {% elif mensa == "Contine" %}
                        <span id="askTrumpEmojiTrigger" style="cursor: pointer;" title="Ask Donald Trump for Contine recommendation">{{ mensa_emojis[mensa] }}</span>
                    {% elif mensa == "XXXLutz Hesse Markrestaurant" %}
                        {{ mensa_emojis[mensa] }} <!-- Removed Tobias recommendation trigger -->
                    {% else %}
                        {{ mensa_emojis[mensa] }}
                    {% endif %}
                </span>
            </h2>

            {% if mensa == "XXXLutz Hesse Markrestaurant" %}
                <!-- XXXLutz Menu - Simple cards for all devices (updated) -->
                <div class="xxxlutz-container">
                    
                    <!-- Weekly dishes section -->
                    <div class="xxxlutz-section mb-4">
                        <a href="{{ url_for('static', filename='menu/menu_hg.pdf') }}" target="_blank" style="text-decoration: none; color: inherit;">
                            <h4 class="xxxlutz-section-title">Wechselnde Gerichte der Woche</h4>
                        </a>
                        <div class="row justify-content-center">
                            {% for meal in meals if meal.category == 'Wechselnde Gerichte Woche' %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="xxxlutz-card">
                                        {{ meal.description }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Permanent menu section -->
                    <div class="xxxlutz-section mb-4">
                        <h4 class="xxxlutz-section-title">Ständiges Angebot</h4>
                        <div class="row justify-content-center">
                            {% for meal in meals if meal.category == 'Ständiges Angebot' %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="xxxlutz-card">
                                        {{ meal.description }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- XXXLutz Vouchers Section - Only shown when Mensa Garbsen is selected -->
                    {% if selected_mensa == "Mensa Garbsen" %}
                    <div class="xxxlutz-section mb-4">
                        <h4 class="xxxlutz-section-title">Gutscheine</h4>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <!-- Use d-flex for horizontal layout on larger screens, flex-column for stacking on small screens -->
                                <div class="voucher-links d-flex flex-column flex-md-row justify-content-center">
                                    <a href="{{ url_for('download_voucher', voucher_type='new') }}" class="btn btn-primary mb-2 me-md-2"> <!-- Added me-md-2 for margin on medium screens and up -->
                                        <i class="fas fa-download"></i> Neue Gutscheine
                                    </a>
                                    <a href="{{ url_for('download_voucher', voucher_type='old') }}" class="btn btn-secondary mb-2">
                                        <i class="fas fa-download"></i> Alte Gutscheine
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu HG section REMOVED -->
                    {#
                    <div class="xxxlutz-section mb-4">
                        <h4 class="xxxlutz-section-title">Mensa HG Speiseplan</h4>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="menu-hg-image">
                                    <img src="{{ url_for('get_menu_hg_image') }}" alt="Mensa HG Speiseplan" class="img-fluid mb-3" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div class="voucher-links">
                                    <a href="{{ url_for('download_menu_hg_pdf') }}" class="btn btn-success mb-2">
                                        <i class="fas fa-download"></i> Speiseplan als PDF herunterladen
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    #}
                    {# REMOVED dedicated Marvin section here #}
                    {% endif %}
                </div>
            {% else %}
                <!-- Regular desktop table view for other mensen -->
                <div class="table-responsive">
                    <table class="table meal-table">
                        <thead>
                            <tr>
                                <th>Essen</th>
                                <th>Studierende</th>
                                <th>Mitarbeitende</th>
                                <th>Gästende</th>
                                <th class="expert-mode-col" style="display: none;">Rkr-Rating nominal</th>
                                <th class="expert-mode-col" style="display: none;">Rkr-Rating real</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for meal in meals %}
                                {% set kcal = meal.nutritional_values|extract_kcal %}
                                {% set protein_g = meal.nutritional_values|extract_protein %}
                                {% set caner_student = kcal|calculate_caner(meal.price_student) %}
                                {% set caner_employee = kcal|calculate_caner(meal.price_employee) %}
                                {% set caner_guest = kcal|calculate_caner(meal.price_guest) %}
                                {% set rkr_nominal_student = protein_g|calculate_rkr_nominal(meal.price_student) %}
                                {% set rkr_real_student = protein_g|calculate_rkr_real(meal.price_student, meal.description) %}

                                <tr>
                                    <td>
                                        <strong>{{ meal.description }}</strong>
                                        <div class="food-markings-row">
                                            {{ meal.marking|get_dietary_info|safe }}
                                            <div class="action-buttons">
                                                {% if meal.nutritional_values %}
                                                <span class="nutrient-info-trigger" 
                                                      data-bs-toggle="popover"
                                                      data-bs-trigger="click" 
                                                      data-bs-placement="top"
                                                      data-bs-html="true" 
                                                      data-bs-content="{{ meal.nutritional_values|format_nutritional_values|safe }}" 
                                                      title="Nährwerte"
                                                      style="cursor: help;">
                                                    <i class="fas fa-info-circle text-info"></i>
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="food-markings-row mt-2">
                                            <div class="vote-controls" data-meal-id="{{ meal.id }}">
                                                <button class="btn btn-sm vote-btn upvote-btn" title="Upvote">
                                                    <i class="fas fa-thumbs-up"></i> <span class="upvote-count">0</span>
                                                </button>
                                                <button class="btn btn-sm vote-btn downvote-btn" title="Downvote">
                                                    <i class="fas fa-thumbs-down"></i> <span class="downvote-count">0</span>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="user-price-caner-info">
                                            <span class="price">{{ meal.price_student }} €</span>
                                            <span class="caner-symbols" data-caner-value="{{ caner_student }}">{{ caner_student|generate_caner_symbols|safe }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="user-price-caner-info">
                                            <span class="price">{{ meal.price_employee }} €</span>
                                            <span class="caner-symbols" data-caner-value="{{ caner_employee }}">{{ caner_employee|generate_caner_symbols|safe }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="user-price-caner-info">
                                            <span class="price">{{ meal.price_guest }} €</span>
                                            <span class="caner-symbols" data-caner-value="{{ caner_guest }}">{{ caner_guest|generate_caner_symbols|safe }}</span>
                                        </div>
                                    </td>
                                    <td class="expert-mode-col" style="display: none;">
                                        <strong class="rkr-value">{{ ("%.2f"|format(rkr_nominal_student)).replace('.', ',') }} Rkrrn</strong>
                                    </td>
                                    <td class="expert-mode-col" style="display: none;">
                                        <strong class="rkr-value">{{ ("%.2f"|format(rkr_real_student)).replace('.', ',') }} Rkrrr</strong>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Regular mobile cards view for other mensen -->
                <div class="mobile-meal-cards">
                    {% for meal in meals %}
                        {% set kcal = meal.nutritional_values|extract_kcal %}
                        {% set kcal = meal.nutritional_values|extract_kcal %}
                        {% set protein_g = meal.nutritional_values|extract_protein %}
                        {% set caner_student = kcal|calculate_caner(meal.price_student) %}
                        {% set caner_employee = kcal|calculate_caner(meal.price_employee) %}
                        {% set caner_guest = kcal|calculate_caner(meal.price_guest) %}
                        {% set rkr_nominal_student = protein_g|calculate_rkr_nominal(meal.price_student) %}
                        {% set rkr_real_student = protein_g|calculate_rkr_real(meal.price_student, meal.description) %}

                        <div class="mobile-meal-card">
                            <div class="mobile-meal-description">
                                {{ meal.description }}
                                <div class="food-markings-row text-center">
                                    {{ meal.marking|get_dietary_info|safe }}
                                    <div class="action-buttons">
                                        {% if meal.nutritional_values %}
                                        <span class="nutrient-info-trigger" 
                                              data-bs-toggle="popover"
                                              data-bs-trigger="click" 
                                              data-bs-placement="top"
                                              data-bs-html="true" 
                                              data-bs-content="{{ meal.nutritional_values|format_nutritional_values|safe }}" 
                                              title="Nährwerte"
                                              style="cursor: help;">
                                            <i class="fas fa-info-circle text-info"></i>
                                        </span>
                                        {% endif %}
                                    </div>
                                
                                <div class="food-markings-row mt-2" style="justify-content: center;">
                                    <div class="vote-controls" data-meal-id="{{ meal.id }}">
                                        <button class="btn btn-sm vote-btn upvote-btn" title="Upvote">
                                            <i class="fas fa-thumbs-up"></i> <span class="upvote-count">0</span>
                                        </button>
                                        <button class="btn btn-sm vote-btn downvote-btn" title="Downvote">
                                            <i class="fas fa-thumbs-down"></i> <span class="downvote-count">0</span>
                                        </button>
                                    </div>
                                </div>
                                </div> {# This closes .food-markings-row, then .mobile-meal-description needs to be closed #}
                            </div> {# This was mobile-meal-description, ensure it's correctly placed after fixing above #}


                            <div class="mobile-user-info-container mt-2">
                                <div class="mobile-user-info-row">
                                    <strong class="mobile-user-label">Studierende:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="price">{{ meal.price_student }} €</span>
                                        <span class="caner-symbols" data-caner-value="{{ caner_student }}">{{ caner_student|generate_caner_symbols|safe }}</span>
                                    </div>
                                </div>
                                <div class="mobile-user-info-row">
                                    <strong class="mobile-user-label">Mitarbeitende:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="price">{{ meal.price_employee }} €</span>
                                        <span class="caner-symbols" data-caner-value="{{ caner_employee }}">{{ caner_employee|generate_caner_symbols|safe }}</span>
                                    </div>
                                </div>
                                <div class="mobile-user-info-row">
                                    <strong class="mobile-user-label">Gästende:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="price">{{ meal.price_guest }} €</span>
                                        <span class="caner-symbols" data-caner-value="{{ caner_guest }}">{{ caner_guest|generate_caner_symbols|safe }}</span>
                                    </div>
                                </div>
                                <div class="mobile-user-info-row expert-mode-col" style="display: none;">
                                    <strong class="mobile-user-label">Rkr-Rating nominal:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="rkr-value-mobile"><strong class="rkr-value">{{ ("%.2f"|format(rkr_nominal_student)).replace('.', ',') }} Rkrrn</strong></span>
                                    </div>
                                </div>
                                <div class="mobile-user-info-row expert-mode-col" style="display: none;">
                                    <strong class="mobile-user-label">Rkr-Rating real:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="rkr-value-mobile"><strong class="rkr-value">{{ ("%.2f"|format(rkr_real_student)).replace('.', ',') }} Rkrrr</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

        </div>
    {% endfor %}
{% else %}
    <div class="alert alert-info">
        Keine Mahlzeiten für das ausgewählte Datum oder die ausgewählte Mensa gefunden.
    </div>
{% endif %}

<!-- AI Recommendation Popup Modal -->
<div id="recommendationPopupModal" class="modal fade" tabindex="-1" aria-labelledby="recommendationPopupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="recommendationPopupContent" 
             style="background-size: cover; background-position: center; padding: 0; border: none; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">
            <div id="recommendationPopupOverlay" 
                 style="position: relative; background-color: rgba(0,0,0,0.65); padding: 1rem; border-radius: 0.3rem;"> 
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="modal-title" id="recommendationPopupModalLabel">AI Empfehlung</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="recommendationPopupBody" 
                     style="min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 10px;">
                    <!-- Content will be injected by JavaScript -->
                    <p>Empfehlung lädt...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const recommendationModalElement = document.getElementById('recommendationPopupModal');
    const recommendationModal = recommendationModalElement ? new bootstrap.Modal(recommendationModalElement) : null;
    const recommendationModalTitle = recommendationModalElement ? recommendationModalElement.querySelector('#recommendationPopupModalLabel') : null;
    const recommendationModalBody = recommendationModalElement ? recommendationModalElement.querySelector('#recommendationPopupBody') : null;
    const recommendationModalContent = recommendationModalElement ? recommendationModalElement.querySelector('#recommendationPopupContent') : null;
    const recommendationModalOverlay = recommendationModalElement ? recommendationModalElement.querySelector('#recommendationPopupOverlay') : null;


    function showRecommendationPopup(title, message, backgroundUrl, isError = false) {
        if (!recommendationModal || !recommendationModalTitle || !recommendationModalBody || !recommendationModalContent || !recommendationModalOverlay) {
            console.error("Popup modal elements not found"); 
            return;
        }

        recommendationModalTitle.textContent = title;
        recommendationModalBody.innerHTML = message.replace(/\n/g, '<br>');
        
        if (backgroundUrl) {
            recommendationModalContent.style.backgroundImage = `url('${backgroundUrl}')`;
        } else {
            recommendationModalContent.style.backgroundImage = 'none'; 
        }
        
        if (isError) {
            recommendationModalOverlay.style.backgroundColor = "rgba(100,0,0,0.75)"; 
        } else {
            recommendationModalOverlay.style.backgroundColor = "rgba(0,0,0,0.65)"; 
        }

        recommendationModal.show();
    }

    function getMealsFromMensaSection(mensaName, isXXXLutz = false) {
        const meals = new Set(); 
        const mensaSections = document.querySelectorAll('.mensa-section');
        let mensaFound = false;
        for (const section of mensaSections) {
            const titleElement = section.querySelector('h2.mensa-title');
            if (titleElement && titleElement.textContent && titleElement.textContent.includes(mensaName)) {
                mensaFound = true;
                if (isXXXLutz) {
                    // Specifically target cards within the xxxlutz-container of the correct mensa section
                    const xxxlutzContainer = section.querySelector('.xxxlutz-container');
                    if (xxxlutzContainer) {
                        xxxlutzContainer.querySelectorAll('.xxxlutz-card').forEach(card => {
                            const mealText = card.textContent.trim();
                            if (mealText) meals.add(mealText);
                        });
                    }
                } else {
                    section.querySelectorAll('.meal-table tbody tr').forEach(row => {
                        const mealDescElement = row.querySelector('td:first-child strong');
                        if (mealDescElement) meals.add(mealDescElement.textContent.trim());
                    });
                    section.querySelectorAll('.mobile-meal-card .mobile-meal-description').forEach(card => {
                        const strongDesc = card.querySelector('strong');
                        let mealText = '';
                        if (strongDesc) {
                            mealText = strongDesc.textContent.trim();
                        } else {
                            let tempText = '';
                            for (const childNode of card.childNodes) {
                                if (childNode.nodeType === Node.TEXT_NODE) {
                                    tempText += childNode.textContent.trim() + ' ';
                                } else if (childNode.nodeType === Node.ELEMENT_NODE && childNode.tagName === 'STRONG') {
                                    tempText += childNode.textContent.trim() + ' ';
                                } else if (childNode.nodeType === Node.ELEMENT_NODE && (childNode.classList.contains('food-markings-row') || childNode.classList.contains('action-buttons'))) {
                                    break; 
                                }
                            }
                            mealText = tempText.trim();
                        }
                        if (mealText && mealText.length > 5) { 
                           meals.add(mealText);
                        }
                    });
                }
                break; 
            }
        }
        if (!mensaFound && (mensaName === 'Mensa Garbsen' || mensaName === 'XXXLutz Hesse Markrestaurant')) {
             console.warn(`Mensa section "${mensaName}" not found for meal collection.`);
        }
        return Array.from(meals); 
    }

    // Marvin Recommendation Trigger
    const marvinEmojiTrigger = document.getElementById('askMarvinEmojiTrigger');
    if (marvinEmojiTrigger && recommendationModal) {
        marvinEmojiTrigger.addEventListener('click', function () {
            const loadingMessage = '<i class="fas fa-spinner fa-spin"></i> Marvin verarbeitet die Sinnlosigkeit deiner Anfrage...';
            showRecommendationPopup("Marvin's Deprimierende Einsicht", loadingMessage, '/static/img/marvin.jpg');

            const garbsenMeals = getMealsFromMensaSection('Mensa Garbsen');
            const xxxLutzMealsForMarvin = getMealsFromMensaSection('XXXLutz Hesse Markrestaurant', true);
            const allMealsForMarvin = [...new Set([...garbsenMeals, ...xxxLutzMealsForMarvin].filter(m => m))];

            if (allMealsForMarvin.length === 0) {
                showRecommendationPopup("Marvin's Antwort", "Es gibt nichts zu bewerten. Ein seltener Moment der Bedeutungslosigkeit, selbst für Marvin.", '/static/img/marvin.jpg', true);
                return;
            }

            fetch('/api/get_marvin_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meals: allMealsForMarvin })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.recommendation) {
                    showRecommendationPopup("Marvin's Deprimierende Einsicht", data.recommendation, '/static/img/marvin.jpg');
                } else { 
                    throw new Error(data.error || "Unbekannter Fehler von Marvin.");
                }
            })
            .catch(error => {
                console.error('Error asking Marvin:', error);
                showRecommendationPopup("Marvin Fehler", `Selbst die Technik ist deprimierend: ${error.message}`, '/static/img/marvin.jpg', true);
            });
        });
    }

    // Tobias Recommendation Trigger
    const tobiasEmojiTrigger = document.getElementById('askTobiasEmojiTrigger');

    // Trump Recommendation Trigger
    const trumpEmojiTrigger = document.getElementById('askTrumpEmojiTrigger');
    if (trumpEmojiTrigger && recommendationModal) {
        trumpEmojiTrigger.addEventListener('click', function () {
            const loadingMessage = '<i class="fas fa-spinner fa-spin"></i> Donald Trump analyzing Contine menu...';
            showRecommendationPopup("Trump's Recommendation", loadingMessage, '/static/img/trump.jpg');

            const contineMeals = getMealsFromMensaSection('Contine');
            if (contineMeals.length === 0) {
                showRecommendationPopup("Trump Error", "No Contine meals found to recommend.", '/static/img/trump.jpg', true);
                return;
            }

            fetch('/api/get_trump_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meals: contineMeals })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.recommendation) {
                    showRecommendationPopup("Donald Trump's Recommendation", data.recommendation, '/static/img/trump.jpg');
                } else {
                    throw new Error(data.error || "Unknown error from Trump API.");
                }
            })
            .catch(error => {
                console.error('Error asking Trump:', error);
                showRecommendationPopup("Trump Error", `Everything is just terrible: ${error.message}`, '/static/img/trump.jpg', true);
            });
        });
    }

    // Bob Recommendation Trigger
    const bobEmojiTrigger = document.getElementById('askBobEmojiTrigger');
    if (bobEmojiTrigger && recommendationModal) {
        bobEmojiTrigger.addEventListener('click', function () {
            const loadingMessage = '<i class="fas fa-spinner fa-spin"></i> Bob der Baumeister is building your recommendation...';
            showRecommendationPopup("Bob's Empfehlung", loadingMessage, '/static/img/bob.png');

            const hauptMeals = getMealsFromMensaSection('Hauptmensa');
            if (hauptMeals.length === 0) {
                showRecommendationPopup("Bob Fehler", "Keine Hauptmensa Gerichte gefunden.", '/static/img/bob.png', true);
                return;
            }

            fetch('/api/get_bob_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meals: hauptMeals })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.recommendation) {
                    showRecommendationPopup("Bob's Empfehlung", data.recommendation, '/static/img/bob.png');
                } else {
                    throw new Error(data.error || "Unbekannter Fehler von Bob.");
                }
            })
                .catch(error => {
                    console.error('Error asking Bob:', error);
                    showRecommendationPopup("Bob Fehler", `Vergiss nicht deinen Helm! ${error.message}`, '/static/img/bob.png', true);
                });
        });
    }
    if (tobiasEmojiTrigger && recommendationModal) {
        tobiasEmojiTrigger.addEventListener('click', function () {
            const loadingMessage = '<i class="fas fa-spinner fa-spin"></i> Tobias sucht begeistert nach der besten Option für dich!';
            showRecommendationPopup("Tobias' Tipp", loadingMessage, '/static/img/tobias.jpg');
            
            const xxxLutzMealsForTobias = getMealsFromMensaSection('XXXLutz Hesse Markrestaurant', true);

            if (xxxLutzMealsForTobias.length === 0) {
                showRecommendationPopup("Tobias' Antwort", "Leider keine XXXLutz Gerichte für eine Empfehlung gefunden. Schade!", '/static/img/tobias.jpg', true);
                return;
            }

            fetch('/api/get-meal-recommendation', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meals: xxxLutzMealsForTobias })
            })
            .then(response => {
                if (!response.ok) { 
                    return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.recommendation) {
                    showRecommendationPopup("Tobias' Empfehlung", data.recommendation, '/static/img/tobias.jpg');
                } else { 
                    throw new Error(data.error || "Unbekannter Fehler von Tobias.");
                }
            })
            .catch(error => {
                console.error('Error asking Tobias:', error);
                showRecommendationPopup("Tobias Fehler", `Da ist wohl was schiefgelaufen: ${error.message}`, '/static/img/tobias.jpg', true);
            });
        });
    }
    
    // Placeholder for existing vote script logic
    /*
    const voteControls = document.querySelectorAll('.vote-controls');
    voteControls.forEach(function(control) {
        // Ensure this part is correctly integrated with your actual voting script if it was previously in this block
    });
    */
    
    // Initialize Bootstrap Popovers for nutrient info triggers
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"].nutrient-info-trigger');
    const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, {
        container: 'body' // Attach popover to body to avoid table/card clipping issues
    }));

    // Expert Mode Toggle
    const expertModeToggleIcon = document.getElementById('expertModeToggleIcon');
    const expertModeCols = document.querySelectorAll('.expert-mode-col');
    let expertModeEnabled = localStorage.getItem('expertModeEnabled') === 'true';

    function applyExpertModeStyles() {
        expertModeCols.forEach(col => {
            if (col.tagName === 'TH' || col.tagName === 'TD') {
                col.style.display = expertModeEnabled ? 'table-cell' : 'none';
            } else { // For mobile view elements (divs behaving as rows/items)
                col.style.display = expertModeEnabled ? 'flex' : 'none';
            }
        });
        if (expertModeToggleIcon) {
            expertModeToggleIcon.style.opacity = expertModeEnabled ? '1' : '0.5';
        }

        const canerElements = document.querySelectorAll('.caner-symbols');
        const rkrElements = document.querySelectorAll('strong.rkr-value');

        if (expertModeEnabled) {
            canerElements.forEach(el => {
                const canerValueText = el.dataset.canerValue;
                if (canerValueText === undefined) return;

                const canerValue = parseFloat(canerValueText);
                if (!isNaN(canerValue)) {
                    let hue;
                    if (canerValue <= 0) {
                        hue = 0; // Red
                    } else if (canerValue >= 600) {
                        hue = 120; // Green
                    } else {
                        hue = (Math.max(0, canerValue) / 600) * 120;
                    }
                    el.style.color = `hsl(${hue}, 100%, 35%)`; 
                }
            });

            rkrElements.forEach(el => {
                const textValue = el.textContent.replace(',', '.').replace(/[^\d.-]/g, '');
                const rkrValue = parseFloat(textValue);

                if (!isNaN(rkrValue)) {
                    let hue;
                    if (rkrValue <= 0) {
                        hue = 0; // Red
                    } else if (rkrValue >= 20) {
                        hue = 120; // Green
                    } else {
                        hue = (Math.max(0, rkrValue) / 20) * 120;
                    }
                    el.style.color = `hsl(${hue}, 100%, 35%)`;
                }
            });

        } else { // Expert mode disabled
            canerElements.forEach(el => {
                el.style.color = ''; // Reset color
            });
            rkrElements.forEach(el => {
                el.style.color = ''; // Reset color
            });
        }
    }

    if (expertModeToggleIcon) {
        applyExpertModeStyles(); // Apply initial state on load

        expertModeToggleIcon.addEventListener('click', function() {
            expertModeEnabled = !expertModeEnabled; // Toggle the state
            localStorage.setItem('expertModeEnabled', expertModeEnabled);
            applyExpertModeStyles();
        });
    }

    // New code for date navigation arrows
    const dateSelectForArrows = document.getElementById('date');
    const mensaSelectForArrows = document.getElementById('mensa');

    document.querySelectorAll('.date-nav-arrow').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            if (this.classList.contains('disabled')) { // Prevent action if button is disabled
                return;
            }

            const direction = this.dataset.direction === 'prev' ? -1 : 1;
            
            if (!dateSelectForArrows || !mensaSelectForArrows) {
                console.error("Date or Mensa select not found for arrow navigation.");
                return;
            }

            const currentSelectedMensa = mensaSelectForArrows.value;
            const currentSelectedDate = dateSelectForArrows.value;
            const allDatesInDropdown = Array.from(dateSelectForArrows.options).map(opt => opt.value);
            
            const currentIndex = allDatesInDropdown.indexOf(currentSelectedDate);

            if (currentIndex === -1) {
                console.error('Current selected date not found in available dates for arrow navigation.');
                return;
            }

            let newIndex = currentIndex + direction;

            // Clamping to bounds. If it results in no change of index, link won't navigate.
            if (newIndex < 0) newIndex = 0;
            else if (newIndex >= allDatesInDropdown.length) newIndex = allDatesInDropdown.length - 1;
            
            const newDate = allDatesInDropdown[newIndex];

            if (newDate && newDate !== currentSelectedDate) { // Only navigate if date actually changes
                const baseUrl = window.location.pathname; 
                const params = new URLSearchParams(window.location.search); 
                params.set('date', newDate);
                params.set('mensa', currentSelectedMensa); 
                
                window.location.href = `${baseUrl}?${params.toString()}`;
            }
        });
    });

    function updateMensaTitleArrowStates() {
        const dateSelectForState = document.getElementById('date');
        if (!dateSelectForState) return;

        const options = Array.from(dateSelectForState.options);
        const currentIndex = dateSelectForState.selectedIndex; 

        let onFirst = false;
        let onLast = false;
        
        if (options.length === 0) { // no dates available
            onFirst = true;
            onLast = true;
        } else if (options.length === 1) { // only one date
            onFirst = true;
            onLast = true;
        } else {
            onFirst = (currentIndex <= 0);
            onLast = (currentIndex >= options.length - 1);
        }

        document.querySelectorAll('.date-nav-arrow[data-direction="prev"]').forEach(btn => {
            btn.classList.toggle('disabled', onFirst);
            if (onFirst) {
                btn.setAttribute('aria-disabled', 'true');
            } else {
                btn.removeAttribute('aria-disabled');
            }
        });
        document.querySelectorAll('.date-nav-arrow[data-direction="next"]').forEach(btn => {
            btn.classList.toggle('disabled', onLast);
             if (onLast) {
                btn.setAttribute('aria-disabled', 'true');
            } else {
                btn.removeAttribute('aria-disabled');
            }
        });
    }

    if (dateSelectForArrows) { 
        updateMensaTitleArrowStates();
    }

    // Initialize Vanilla JS Datepicker
    const datepickerEl = document.getElementById('date');
    if (datepickerEl) {
        const availableDatesStrings = [{% for date_str in available_dates %}"{{ date_str }}"{% if not loop.last %}, {% endif %}{% endfor %}];
        
        const datepicker = new Datepicker(datepickerEl, {
            format: 'dd.mm.yyyy',
            language: 'de',
            autohide: true,
            todayHighlight: true,
            // Function to enable only specific dates
            datesDisabled: [], // Initialize, then fill based on available_dates
            filter: (date) => {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0); // Normalize to start of day for comparison
                
                // The date object 'date' passed by the filter is already UTC. 
                // We need to compare it with our available_dates which are strings in 'dd.mm.yyyy' format.
                // It's generally safer to convert input 'date' to a string in 'dd.mm.yyyy' for comparison if availableDatesStrings are local dates.
                // Or, convert availableDateStrings to Date objects in UTC for comparison.

                // Create a local date string from the picker's date object using its parts
                // to avoid timezone issues that arise from direct toISOString() or similar on local-intended dates.
                const year = d.getFullYear();
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const day = d.getDate().toString().padStart(2, '0');
                const currentDateString = `${day}.${month}.${year}`;

                return availableDatesStrings.includes(currentDateString);
            }
        });

        datepickerEl.addEventListener('changeDate', function(event) {
            // When a date is selected from the picker, submit the form.
            // The 'value' of the input field is automatically updated by the datepicker.
            // Ensure this.form refers to the correct form containing the date input.
            // The onchange="this.form.submit()" from the original select is effectively replaced by this.
            const form = datepickerEl.closest('form');
            if (form) {
                form.submit();
            } else {
                console.error("Datepicker could not find parent form to submit.");
            }
        });
    } else {
        console.error("Datepicker input element not found.")
    }

});
</script>
{% endblock %}
