{% extends "base.html" %}

{% block content %}

{% if data %}
    {% if dashboard_mode %}
        <!-- Dashboard Mode: Side-by-side layout -->
        <div class="dashboard-container">
            <div class="row">
                <!-- Left Column: Selected Mensa -->
                <div class="col-lg-6 dashboard-column">
                    {% for mensa, meals in data.items() if mensa != "XXXLutz Hesse Markrestaurant" %}
                                            <div class="mensa-section mb-4">
                                                <h2 class="mensa-title" style="display: grid; grid-template-columns: auto 1fr auto; align-items: center;">
                                                    {% if mensa == selected_mensa %}
                                                        <a href="#" role="button" class="btn btn-sm btn-outline-secondary date-nav-arrow" data-direction="prev" title="Vorheriger Tag"><i class="fas fa-chevron-left"></i></a>
                                                    {% endif %}
                    
                                                    <span class="mensa-name-and-emoji-wrapper text-center{% if mensa == 'XXXLutz Hesse Markrestaurant' %} xxxlutz-title{% endif %}">
                                    {% if mensa == "Mensa Garbsen" %}
                                        <span class="mensa-name-text">{{ mensa }}</span>
                                    {% else %}
                                        <span class="mensa-name-text">{{ mensa }}</span>
                                    {% endif %}
                                    <span class="ms-2">
                                        {% if mensa == "Mensa Garbsen" %}
                                            <span id="askMarvinEmojiTrigger" style="cursor: pointer;" title="Frag Marvin zu Mensa Garbsen & XXXLutz">{{ mensa_emojis[mensa] }}</span>
                                        {% elif mensa == "Hauptmensa" %}
                                            <span id="askBobEmojiTrigger" style="cursor: pointer;" title="Frag Bob der Baumeister zur Hauptmensa">{{ mensa_emojis[mensa] }}</span>
                                        {% elif mensa == "Contine" %}
                                            <span id="askTrumpEmojiTrigger" style="cursor: pointer;" title="Ask Donald Trump for Contine recommendation">{{ mensa_emojis[mensa] }}</span>
                                        {% elif mensa == "XXXLutz Hesse Markrestaurant" %}
                                            <span id="askDarkCanerEmojiTrigger" style="cursor: pointer;" title="Frag Dark Caner, den Gangsta Rapper, für XXXLutz Tipps">{{ mensa_emojis[mensa] }}</span>
                                        {% else %}
                                            {{ mensa_emojis[mensa] }}
                                        {% endif %}
                                    </span>
                                </span>
                            
                                {% if mensa == selected_mensa %}
                                    <div class="d-flex align-items-center ms-auto">
                                        <div class="me-2">
                                            <select name="mensa" id="mensa" class="form-select form-select-sm" onchange="const params = new URLSearchParams(); params.set('mensa', this.value); params.set('date', document.getElementById('date').value); window.location.href = `/?${params.toString()}`;">
                                                {% for mensa in available_mensen %}
                                                    <option value="{{ mensa }}" {% if mensa == selected_mensa %}selected{% endif %}>
                                                        {{ mensa }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <a href="#" role="button" class="btn btn-sm btn-outline-secondary date-nav-arrow" data-direction="next" title="Nächster Tag"><i class="fas fa-chevron-right"></i></a>
                                    </div>
                                {% endif %}
                            </h2>

                            {% if mensa == "XXXLutz Hesse Markrestaurant" %}
                                <!-- XXXLutz Menu - Simple cards for all devices (updated) -->
                                <div class="xxxlutz-container">
                                    <!-- Weekly dishes section -->
                                    <div class="xxxlutz-section mb-4">
                                        <h4 class="xxxlutz-section-title">Wechselnde Gerichte der Woche</h4>
                                        <div class="row justify-content-center">
                                            {% for meal in meals if meal.category == 'Wechselnde Gerichte Woche' %}
                                                <div class="col-md-6 col-lg-4 mb-3">
                                                    <div class="xxxlutz-card">
                                                        {{ meal.description }}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- Permanent menu section -->
                                    <div class="xxxlutz-section mb-4">
                                        <h4 class="xxxlutz-section-title">Ständiges Angebot</h4>
                                        <div class="row justify-content-center">
                                            {% for meal in meals if meal.category == 'Ständiges Angebot' %}
                                                <div class="col-md-6 col-lg-4 mb-3">
                                                    <div class="xxxlutz-card">
                                                        {{ meal.description }}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <!-- Regular desktop table view for other mensen -->
                                <div class="table-responsive">
                                    <table class="table meal-table">
                                        <thead>
                                            <tr>
                                                <th>Essen</th>
                                                <th>Studierende</th>
                                                <th>Mitarbeitende</th>
                                                <th>Gästende</th>
                                                <th class="expert-mode-col" style="display: none;">Rkr nominal</th>
                                                <th class="expert-mode-col" style="display: none;">Rkr real</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for meal in meals %}
                                                {% set kcal = meal.nutritional_values|extract_kcal %}
                                                {% set protein_g = meal.nutritional_values|extract_protein %}
                                                {% set caner_student = kcal|calculate_caner(meal.price_student) %}
                                                {% set caner_employee = kcal|calculate_caner(meal.price_employee) %}
                                                {% set caner_guest = kcal|calculate_caner(meal.price_guest) %}
                                                {% set rkr_nominal_student = protein_g|calculate_rkr_nominal(meal.price_student) %}
                                                {% set rkr_real_student = protein_g|calculate_rkr_real(meal.price_student, meal.description) %}

                                                <tr>
                                                    <td>
                                                        <strong>{{ meal.description }}</strong>
                                                        <div class="food-markings-row">
                                                            {{ meal.marking|get_dietary_info|safe }}
                                                            <div class="action-buttons">
                                                                {% if meal.nutritional_values %}
                                                                <span class="nutrient-info-trigger"
                                                                      data-bs-toggle="popover"
                                                                      data-bs-trigger="click"
                                                                      data-bs-placement="top"
                                                                      data-bs-html="true"
                                                                      data-bs-content="{{ meal.nutritional_values|format_nutritional_values|safe }}"
                                                                      title="Nährwerte"
                                                                      style="cursor: help;">
                                                                    <i class="fas fa-info-circle text-info"></i>
                                                                </span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        <div class="food-markings-row mt-2">
                                                            <div class="vote-controls" data-meal-id="{{ meal.id }}">
                                                                <button class="btn btn-sm vote-btn upvote-btn" title="Upvote">
                                                                    <i class="fas fa-thumbs-up"></i> <span class="upvote-count">0</span>
                                                                </button>
                                                                <button class="btn btn-sm vote-btn downvote-btn" title="Downvote">
                                                                    <i class="fas fa-thumbs-down"></i> <span class="downvote-count">0</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="user-price-caner-info">
                                                            <span class="price">{{ meal.price_student }} €</span>
                                                            <span class="caner-symbols" data-caner-value="{{ caner_student }}">{{ caner_student|generate_caner_symbols|safe }}</span>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="user-price-caner-info">
                                                            <span class="price">{{ meal.price_employee }} €</span>
                                                            <span class="caner-symbols" data-caner-value="{{ caner_employee }}">{{ caner_employee|generate_caner_symbols|safe }}</span>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="user-price-caner-info">
                                                            <span class="price">{{ meal.price_guest }} €</span>
                                                            <span class="caner-symbols" data-caner-value="{{ caner_guest }}">{{ caner_guest|generate_caner_symbols|safe }}</span>
                                                        </div>
                                                    </td>
                                                    <td class="expert-mode-col" style="display: none;">
                                                        <strong class="rkr-value">{{ ("%.2f"|format(rkr_nominal_student)).replace('.', ',') }} RkrN</strong>
                                                    </td>
                                                    <td class="expert-mode-col" style="display: none;">
                                                        <strong class="rkr-value">{{ ("%.2f"|format(rkr_real_student)).replace('.', ',') }} RkrR</strong>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Regular mobile cards view for other mensen -->
                                <div class="mobile-meal-cards">
                                    {% for meal in meals %}
                                        {% set kcal = meal.nutritional_values|extract_kcal %}
                                        {% set protein_g = meal.nutritional_values|extract_protein %}
                                        {% set caner_student = kcal|calculate_caner(meal.price_student) %}
                                        {% set caner_employee = kcal|calculate_caner(meal.price_employee) %}
                                        {% set caner_guest = kcal|calculate_caner(meal.price_guest) %}
                                        {% set rkr_nominal_student = protein_g|calculate_rkr_nominal(meal.price_student) %}
                                        {% set rkr_real_student = protein_g|calculate_rkr_real(meal.price_student, meal.description) %}

                                        <div class="mobile-meal-card">
                                            <div class="mobile-meal-description">
                                                {{ meal.description }}
                                                <div class="food-markings-row text-center">
                                                    {{ meal.marking|get_dietary_info|safe }}
                                                    <div class="action-buttons">
                                                        {% if meal.nutritional_values %}
                                                        <span class="nutrient-info-trigger"
                                                              data-bs-toggle="popover"
                                                              data-bs-trigger="click"
                                                              data-bs-placement="top"
                                                              data-bs-html="true"
                                                              data-bs-content="{{ meal.nutritional_values|format_nutritional_values|safe }}"
                                                              title="Nährwerte"
                                                              style="cursor: help;">
                                                            <i class="fas fa-info-circle text-info"></i>
                                                        </span>
                                                        {% endif %}
                                                    </div>

                                                    <div class="food-markings-row mt-2" style="justify-content: center;">
                                                        <div class="vote-controls" data-meal-id="{{ meal.id }}">
                                                            <button class="btn btn-sm vote-btn upvote-btn" title="Upvote">
                                                                <i class="fas fa-thumbs-up"></i> <span class="upvote-count">0</span>
                                                            </button>
                                                            <button class="btn btn-sm vote-btn downvote-btn" title="Downvote">
                                                                <i class="fas fa-thumbs-down"></i> <span class="downvote-count">0</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mobile-user-info-container mt-2">
                                                <div class="mobile-user-info-row">
                                                    <strong class="mobile-user-label">Studierende:</strong>
                                                    <div class="user-price-caner-info mobile-layout">
                                                        <span class="price">{{ meal.price_student }} €</span>
                                                        <span class="caner-symbols" data-caner-value="{{ caner_student }}">{{ caner_student|generate_caner_symbols|safe }}</span>
                                                    </div>
                                                </div>
                                                <div class="mobile-user-info-row">
                                                    <strong class="mobile-user-label">Mitarbeitende:</strong>
                                                    <div class="user-price-caner-info mobile-layout">
                                                        <span class="price">{{ meal.price_employee }} €</span>
                                                        <span class="caner-symbols" data-caner-value="{{ caner_employee }}">{{ caner_employee|generate_caner_symbols|safe }}</span>
                                                    </div>
                                                </div>
                                                <div class="mobile-user-info-row">
                                                    <strong class="mobile-user-label">Gästende:</strong>
                                                    <div class="user-price-caner-info mobile-layout">
                                                        <span class="price">{{ meal.price_guest }} €</span>
                                                        <span class="caner-symbols" data-caner-value="{{ caner_guest }}">{{ caner_guest|generate_caner_symbols|safe }}</span>
                                                    </div>
                                                </div>
                                                <div class="mobile-user-info-row expert-mode-col" style="display: none;">
                                                    <strong class="mobile-user-label">Rkr nominal:</strong>
                                                    <div class="user-price-caner-info mobile-layout">
                                                        <span class="rkr-value-mobile"><strong class="rkr-value">{{ ("%.2f"|format(rkr_nominal_student)).replace('.', ',') }} RkrN</strong></span>
                                                    </div>
                                                </div>
                                                <div class="mobile-user-info-row expert-mode-col" style="display: none;">
                                                    <strong class="mobile-user-label">Rkr real:</strong>
                                                    <div class="user-price-caner-info mobile-layout">
                                                        <span class="rkr-value-mobile"><strong class="rkr-value">{{ ("%.2f"|format(rkr_real_student)).replace('.', ',') }} RkrR</strong></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                
                                    <!-- Compact Dietary Markings Legend inside mobile-meal-cards -->
                                    {% if mensa != "XXXLutz Hesse Markrestaurant" %}
                                    {% if marking_info %}
                                    <div class="mt-2" style="font-size: 0.8em;">
                                        <div class="d-flex flex-wrap justify-content-center gap-2">
                                            {% for code, info in marking_info.items() %}
                                            <span class="d-inline-flex align-items-center" style="font-size: 0.8em;" title="{{ info.title }}">
                                                <span style="font-size: 1.2em; margin-right: 0.2em;">{{ info.emoji }}</span>
                                                <span>{{ info.title }}</span>
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            {% endif %}

                        </div>
                    {% endfor %}
                </div>

                <!-- Right Column: XXXLutz Hesse + Marvin Recommendation -->
                <div class="col-lg-6 dashboard-column">
                    {% for mensa, meals in data.items() if mensa == "XXXLutz Hesse Markrestaurant" %}
                        <div class="mensa-section mb-4">
                            <h2 class="mensa-title d-flex align-items-center justify-content-between">
                                {% if mensa == selected_mensa %}
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <label for="date" class="form-label small">Datum</label>
                                            <input type="text" name="date" id="date" class="form-control form-control-sm" value="{{ selected_date }}" readonly>
                                        </div>
                                        <a href="#" role="button" class="btn btn-sm btn-outline-secondary date-nav-arrow" data-direction="prev" title="Vorheriger Tag"><i class="fas fa-chevron-left"></i></a>
                                    </div>
                                {% endif %}
                                <span class="mensa-name-and-emoji-wrapper text-center{% if mensa == 'XXXLutz Hesse Markrestaurant' %} xxxlutz-title{% endif %}">
                                    <span class="mensa-name-text">{{ mensa }}</span>
                                    <span class="ms-2">
                                        <span id="askDarkCanerEmojiTrigger" style="cursor: pointer;" title="Frag Dark Caner, den Gangsta Rapper, für XXXLutz Tipps">{{ mensa_emojis[mensa] }}</span>
                                    </span>
                                </span>
                                {% if mensa == selected_mensa %}
                                    <a href="#" role="button" class="btn btn-sm btn-outline-secondary date-nav-arrow" data-direction="next" title="Nächster Tag"><i class="fas fa-chevron-right"></i></a>
                                {% endif %}
                            </h2>

                            <!-- XXXLutz Menu - Simple cards for all devices (updated) -->
                            <div class="xxxlutz-container">
                                <!-- Weekly dishes section -->
                                <div class="xxxlutz-section mb-4">
                                    <h4 class="xxxlutz-section-title">Wechselnde Gerichte der Woche</h4>
                                    <div class="row justify-content-center">
                                        {% for meal in meals if meal.category == 'Wechselnde Gerichte Woche' %}
                                            <div class="col-md-6 col-lg-4 mb-3">
                                                <div class="xxxlutz-card">
                                                    {{ meal.description }}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Permanent menu section -->
                                <div class="xxxlutz-section mb-4">
                                    <h4 class="xxxlutz-section-title">Ständiges Angebot</h4>
                                    <div class="row justify-content-center">
                                        {% for meal in meals if meal.category == 'Ständiges Angebot' %}
                                            <div class="col-md-6 col-lg-4 mb-3">
                                                <div class="xxxlutz-card">
                                                    {{ meal.description }}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Marvin Recommendation Section -->
                    <div class="marvin-recommendation-section card mb-4">
                        <div class="card-header bg-primary text-white d-flex align-items-center">
                            <img src="/static/img/marvin.jpg" alt="Marvin" class="rounded-circle me-2" style="width: 40px; height: 40px;">
                            <h5 class="mb-0">Marvin's Empfehlung</h5>
                        </div>
                        <div class="card-body">
                            <div id="marvin-recommendation-content" class="text-center">
                                <p class="text-muted">Lade Marvin's deprimierende Einsicht...</p>
                                <button id="load-marvin-recommendation" class="btn btn-outline-primary">
                                    <i class="fas fa-brain"></i> Marvin fragen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Normal Mode: Single column layout -->
        {% for mensa, meals in data.items() %}
                    <div class="mensa-section mb-4">
                    <h2 class="mensa-title d-flex align-items-center justify-content-between">
                        {% if mensa == selected_mensa %}
                            <div class="d-flex align-items-center">
                                <a href="#" role="button" class="btn btn-sm btn-outline-secondary date-nav-arrow me-1" data-direction="prev" title="Vorheriger Tag"><i class="fas fa-chevron-left"></i></a>
                                <input type="text" name="date" id="date" class="form-control form-control-sm" value="{{ selected_date }}" readonly>
                            </div>
                        {% endif %}

                        <span class="mensa-name-and-emoji-wrapper text-center{% if mensa == 'XXXLutz Hesse Markrestaurant' %} xxxlutz-title{% endif %}">
                    {% if mensa == "Mensa Garbsen" %}
                        <span class="mensa-name-text">{{ mensa }}</span>
                    {% else %}
                        <span class="mensa-name-text">{{ mensa }}</span>
                    {% endif %}
                    <span class="ms-2">
                        {% if mensa == "Mensa Garbsen" %}
                            <span id="askMarvinEmojiTrigger" style="cursor: pointer;" title="Frag Marvin nur zu Mensa Garbsen">{{ mensa_emojis[mensa] }}</span>
                        {% elif mensa == "Hauptmensa" %}
                            <span id="askBobEmojiTrigger" style="cursor: pointer;" title="Frag Bob der Baumeister zur Hauptmensa">{{ mensa_emojis[mensa] }}</span>
                        {% elif mensa == "Contine" %}
                            <span id="askTrumpEmojiTrigger" style="cursor: pointer;" title="Ask Donald Trump for Contine recommendation">{{ mensa_emojis[mensa] }}</span>
                        {% elif mensa == "XXXLutz Hesse Markrestaurant" %}
                            <span id="askDarkCanerEmojiTrigger" style="cursor: pointer;" title="Frag Dark Caner, den Gangsta Rapper, für XXXLutz Tipps">{{ mensa_emojis[mensa] }}</span>
                        {% else %}
                            {{ mensa_emojis[mensa] }}
                        {% endif %}
                    </span>
                </span>

                        {% if mensa == selected_mensa %}
                            <div class="d-flex align-items-center">
                                <select name="mensa" id="mensa" class="form-select form-select-sm me-1" onchange="const params = new URLSearchParams(); params.set('mensa', this.value); params.set('date', document.getElementById('date').value); window.location.href = `/?${params.toString()}`;">
                                    {% for mensa in available_mensen %}
                                        <option value="{{ mensa }}" {% if mensa == selected_mensa %}selected{% endif %}>
                                            {{ mensa }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <a href="#" role="button" class="btn btn-sm btn-outline-secondary date-nav-arrow" data-direction="next" title="Nächster Tag"><i class="fas fa-chevron-right"></i></a>
                            </div>
                        {% endif %}

                    </h2>

            {% if mensa == "XXXLutz Hesse Markrestaurant" %}
                <!-- XXXLutz Menu - Simple cards for all devices (updated) -->
                <div class="xxxlutz-container">
                    
                    <!-- Weekly dishes section -->
                    <div class="xxxlutz-section mb-4">
                        <!-- <a href="{{ url_for('static', filename='menu/menu_hg.pdf') }}" target="_blank" style="text-decoration: none; color: inherit;">
                            <h4 class="xxxlutz-section-title">Wechselnde Gerichte der Woche</h4>
                        </a> -->
                        <h4 class="xxxlutz-section-title">Wechselnde Gerichte der Woche</h4>
                        <div class="row justify-content-center">
                            {% for meal in meals if meal.category == 'Wechselnde Gerichte Woche' %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="xxxlutz-card">
                                        {{ meal.description }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Permanent menu section -->
                    <div class="xxxlutz-section mb-4">
                        <h4 class="xxxlutz-section-title">Ständiges Angebot</h4>
                        <div class="row justify-content-center">
                            {% for meal in meals if meal.category == 'Ständiges Angebot' %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="xxxlutz-card">
                                        {{ meal.description }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- XXXLutz Vouchers Section - Only shown when Mensa Garbsen is selected -->
                    {% if selected_mensa == "Mensa Garbsen" %}
                    <div class="xxxlutz-section mb-4">
                        <h4 class="xxxlutz-section-title">Gutscheine</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="xxxlutz-card">
                                    <a href="{{ url_for('download_voucher', voucher_type='new') }}" class="text-decoration-none d-block p-3">
                                        <i class="fas fa-download"></i> Neue Gutscheine
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="xxxlutz-card">
                                    <a href="{{ url_for('download_voucher', voucher_type='old') }}" class="text-decoration-none d-block p-3">
                                        <i class="fas fa-download"></i> Alte Gutscheine
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu HG section REMOVED -->
                    {#
                    <div class="xxxlutz-section mb-4">
                        <h4 class="xxxlutz-section-title">Mensa HG Speiseplan</h4>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="menu-hg-image">
                                    <img src="{{ url_for('get_menu_hg_image') }}" alt="Mensa HG Speiseplan" class="img-fluid mb-3" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div class="voucher-links">
                                    <a href="{{ url_for('download_menu_hg_pdf') }}" class="btn btn-success mb-2">
                                        <i class="fas fa-download"></i> Speiseplan als PDF herunterladen
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    #}
                    {# REMOVED dedicated Marvin section here #}
                    {% endif %}
                </div>
            {% else %}
                <!-- Regular desktop table view for other mensen -->
                <div class="table-responsive">
                    <table class="table meal-table">
                        <thead>
                            <tr>
                                <th>Essen</th>
                                <th>Studierende</th>
                                <th>Mitarbeitende</th>
                                <th>Gästende</th>
                                <th class="expert-mode-col" style="display: none;">Rkr nominal</th>
                                <th class="expert-mode-col" style="display: none;">Rkr real</th>
                                <th class="expert-mode-col" style="display: none;">MPS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for meal in meals %}
                                {% set kcal = meal.nutritional_values|extract_kcal %}
                                {% set protein_g = meal.nutritional_values|extract_protein %}
                                {% set caner_student = kcal|calculate_caner(meal.price_student) %}
                                {% set caner_employee = kcal|calculate_caner(meal.price_employee) %}
                                {% set caner_guest = kcal|calculate_caner(meal.price_guest) %}
                                {% set rkr_nominal_student = protein_g|calculate_rkr_nominal(meal.price_student) %}
                                {% set rkr_real_student = protein_g|calculate_rkr_real(meal.price_student, meal.description) %}

                                <tr>
                                    <td>
                                        <strong>{{ meal.description }}</strong>
                                        <div class="food-markings-row">
                                            {{ meal.marking|get_dietary_info|safe }}
                                            <div class="action-buttons">
                                                {% if meal.nutritional_values %}
                                                <span class="nutrient-info-trigger" 
                                                      data-bs-toggle="popover"
                                                      data-bs-trigger="click" 
                                                      data-bs-placement="top"
                                                      data-bs-html="true" 
                                                      data-bs-content="{{ meal.nutritional_values|format_nutritional_values|safe }}" 
                                                      title="Nährwerte"
                                                      style="cursor: help;">
                                                    <i class="fas fa-info-circle text-info"></i>
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="food-markings-row mt-2">
                                            <div class="vote-controls" data-meal-id="{{ meal.id }}">
                                                <button class="btn btn-sm vote-btn upvote-btn" title="Upvote">
                                                    <i class="fas fa-thumbs-up"></i> <span class="upvote-count">0</span>
                                                </button>
                                                <button class="btn btn-sm vote-btn downvote-btn" title="Downvote">
                                                    <i class="fas fa-thumbs-down"></i> <span class="downvote-count">0</span>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="user-price-caner-info">
                                            <span class="price">{{ meal.price_student }} €</span>
                                            <span class="caner-symbols" data-caner-value="{{ caner_student }}">{{ caner_student|generate_caner_symbols|safe }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="user-price-caner-info">
                                            <span class="price">{{ meal.price_employee }} €</span>
                                            <span class="caner-symbols" data-caner-value="{{ caner_employee }}">{{ caner_employee|generate_caner_symbols|safe }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="user-price-caner-info">
                                            <span class="price">{{ meal.price_guest }} €</span>
                                            <span class="caner-symbols" data-caner-value="{{ caner_guest }}">{{ caner_guest|generate_caner_symbols|safe }}</span>
                                        </div>
                                    </td>
                                    <td class="expert-mode-col" style="display: none;">
                                        <strong class="rkr-value">{{ ("%.2f"|format(rkr_nominal_student)).replace('.', ',') }} RkrN</strong>
                                    </td>
                                    <td class="expert-mode-col" style="display: none;">
                                        <strong class="rkr-value">{{ ("%.2f"|format(rkr_real_student)).replace('.', ',') }} RkrR</strong>
                                    </td>
                                    <td class="expert-mode-col" style="display: none;">
                                        {% if meal.mps_score is not none %}
                                            <strong class="mps-value">{{ ("%.1f"|format(meal.mps_score)).replace('.', ',') }} MPS</strong>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Regular mobile cards view for other mensen -->
                <div class="mobile-meal-cards">
                    {% for meal in meals %}
                        {% set kcal = meal.nutritional_values|extract_kcal %}
                        {% set kcal = meal.nutritional_values|extract_kcal %}
                        {% set protein_g = meal.nutritional_values|extract_protein %}
                        {% set caner_student = kcal|calculate_caner(meal.price_student) %}
                        {% set caner_employee = kcal|calculate_caner(meal.price_employee) %}
                        {% set caner_guest = kcal|calculate_caner(meal.price_guest) %}
                        {% set rkr_nominal_student = protein_g|calculate_rkr_nominal(meal.price_student) %}
                        {% set rkr_real_student = protein_g|calculate_rkr_real(meal.price_student, meal.description) %}

                        <div class="mobile-meal-card">
                            <div class="mobile-meal-description">
                                {{ meal.description }}
                                <div class="food-markings-row text-center">
                                    {{ meal.marking|get_dietary_info|safe }}
                                    <div class="action-buttons">
                                        {% if meal.nutritional_values %}
                                        <span class="nutrient-info-trigger" 
                                              data-bs-toggle="popover"
                                              data-bs-trigger="click" 
                                              data-bs-placement="top"
                                              data-bs-html="true" 
                                              data-bs-content="{{ meal.nutritional_values|format_nutritional_values|safe }}" 
                                              title="Nährwerte"
                                              style="cursor: help;">
                                            <i class="fas fa-info-circle text-info"></i>
                                        </span>
                                        {% endif %}
                                    </div>
                                
                                <div class="food-markings-row mt-2" style="justify-content: center;">
                                    <div class="vote-controls" data-meal-id="{{ meal.id }}">
                                        <button class="btn btn-sm vote-btn upvote-btn" title="Upvote">
                                            <i class="fas fa-thumbs-up"></i> <span class="upvote-count">0</span>
                                        </button>
                                        <button class="btn btn-sm vote-btn downvote-btn" title="Downvote">
                                            <i class="fas fa-thumbs-down"></i> <span class="downvote-count">0</span>
                                        </button>
                                    </div>
                                </div>
                                </div> {# This closes .food-markings-row, then .mobile-meal-description needs to be closed #}
                            </div> {# This was mobile-meal-description, ensure it\'s correctly placed after fixing above #}


                            <div class="mobile-user-info-container mt-2">
                                <div class="mobile-user-info-row">
                                    <strong class="mobile-user-label">Studierende:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="price">{{ meal.price_student }} €</span>
                                        <span class="caner-symbols" data-caner-value="{{ caner_student }}">{{ caner_student|generate_caner_symbols|safe }}</span>
                                    </div>
                                </div>
                                <div class="mobile-user-info-row">
                                    <strong class="mobile-user-label">Mitarbeitende:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="price">{{ meal.price_employee }} €</span>
                                        <span class="caner-symbols" data-caner-value="{{ caner_employee }}">{{ caner_employee|generate_caner_symbols|safe }}</span>
                                    </div>
                                </div>
                                <div class="mobile-user-info-row">
                                    <strong class="mobile-user-label">Gästende:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="price">{{ meal.price_guest }} €</span>
                                        <span class="caner-symbols" data-caner-value="{{ caner_guest }}">{{ caner_guest|generate_caner_symbols|safe }}</span>
                                    </div>
                                </div>
                                <div class="mobile-user-info-row expert-mode-col" style="display: none;">
                                    <strong class="mobile-user-label">Rkr nominal:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="rkr-value-mobile"><strong class="rkr-value">{{ ("%.2f"|format(rkr_nominal_student)).replace('.', ',') }} RkrN</strong></span>
                                    </div>
                                </div>
                                <div class="mobile-user-info-row expert-mode-col" style="display: none;">
                                    <strong class="mobile-user-label">Rkr real:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        <span class="rkr-value-mobile"><strong class="rkr-value">{{ ("%.2f"|format(rkr_real_student)).replace('.', ',') }} RkrR</strong></span>
                                    </div>
                                </div>
                                <div class="mobile-user-info-row expert-mode-col" style="display: none;">
                                    <strong class="mobile-user-label">MPS:</strong>
                                    <div class="user-price-caner-info mobile-layout">
                                        {% if meal.mps_score is not none %}
                                            <span class="mps-value-mobile"><strong class="mps-value">{{ ("%.1f"|format(meal.mps_score)).replace('.', ',') }} MPS</strong></span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                        </div>
                    {% endfor %}

                    <!-- Compact Dietary Markings Legend inside mobile-meal-cards -->
                    {% if mensa != "XXXLutz Hesse Markrestaurant" %}
                    {% if marking_info %}
                    <div class="mt-2" style="font-size: 0.8em;">
                        <div class="d-flex flex-wrap justify-content-center gap-2">
                            {% for code, info in marking_info.items() %}
                            <span class="d-inline-flex align-items-center" style="font-size: 0.8em;" title="{{ info.title }}">
                                <span style="font-size: 1.2em; margin-right: 0.2em;">{{ info.emoji }}</span>
                                <span>{{ info.title }}</span>
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            {% endif %}

        </div>

    {% endfor %}
{% endif %}
{% else %}
    <div class="alert alert-info">
        Keine Mahlzeiten für das ausgewählte Datum oder die ausgewählte Mensa gefunden.
    </div>
{% endif %}

<!-- AI Recommendation Popup Modal -->
<div id="recommendationPopupModal" class="modal fade" tabindex="-1" aria-labelledby="recommendationPopupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="recommendationPopupContent" 
             style="background-size: cover; background-position: center; padding: 0; border: none; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">
            <div id="recommendationPopupOverlay" 
                 style="position: relative; background-color: rgba(0,0,0,0.65); padding: 1rem; border-radius: 0.3rem;"> 
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="modal-title" id="recommendationPopupModalLabel">AI Empfehlung</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="recommendationPopupBody" 
                     style="min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 10px;">
                    <!-- Content will be injected by JavaScript -->
                    <p>Empfehlung lädt...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const recommendationModalElement = document.getElementById('recommendationPopupModal');
    const recommendationModal = recommendationModalElement ? new bootstrap.Modal(recommendationModalElement) : null;
    const recommendationModalTitle = recommendationModalElement ? recommendationModalElement.querySelector('#recommendationPopupModalLabel') : null;
    const recommendationModalBody = recommendationModalElement ? recommendationModalElement.querySelector('#recommendationPopupBody') : null;
    const recommendationModalContent = recommendationModalElement ? recommendationModalElement.querySelector('#recommendationPopupContent') : null;
    const recommendationModalOverlay = recommendationModalElement ? recommendationModalElement.querySelector('#recommendationPopupOverlay') : null;


    function showRecommendationPopup(title, message, backgroundUrl, isError = false) {
        if (!recommendationModal || !recommendationModalTitle || !recommendationModalBody || !recommendationModalContent || !recommendationModalOverlay) {
            console.error("Popup modal elements not found");
            return;
        }

        recommendationModalTitle.textContent = title;
        recommendationModalBody.innerHTML = message.replace(/\n/g, '<br>');

        if (backgroundUrl) {
            recommendationModalContent.style.backgroundImage = `url('${backgroundUrl}')`;
        } else {
            recommendationModalContent.style.backgroundImage = 'none';
        }

        if (isError) {
            recommendationModalOverlay.style.backgroundColor = "rgba(100,0,0,0.75)";
        } else {
            recommendationModalOverlay.style.backgroundColor = "rgba(0,0,0,0.65)";
        }

        recommendationModal.show();
    }

    function getMealsFromMensaSection(mensaName, isXXXLutz = false) {
        const meals = new Set(); 
        const mensaSections = document.querySelectorAll('.mensa-section');
        let mensaFound = false;
        for (const section of mensaSections) {
            const titleElement = section.querySelector('h2.mensa-title');
            if (titleElement && titleElement.textContent && titleElement.textContent.includes(mensaName)) {
                mensaFound = true;
                if (isXXXLutz) {
                    // Specifically target cards within the xxxlutz-container of the correct mensa section
                    // Exclude voucher sections by only looking at meal sections
                    const xxxlutzContainer = section.querySelector('.xxxlutz-container');
                    if (xxxlutzContainer) {
                        // Only collect meals from actual meal sections, not voucher sections
                        xxxlutzContainer.querySelectorAll('.xxxlutz-section').forEach(xxxlutzSection => {
                            const sectionTitle = xxxlutzSection.querySelector('.xxxlutz-section-title');
                            // Only include sections with meal titles, exclude "Gutscheine" section
                            if (sectionTitle && sectionTitle.textContent) {
                                const titleText = sectionTitle.textContent.trim();
                                if (titleText === 'Wechselnde Gerichte der Woche' || titleText === 'Ständiges Angebot') {
                                    xxxlutzSection.querySelectorAll('.xxxlutz-card').forEach(card => {
                                        const mealText = card.textContent.trim();
                                        if (mealText) meals.add(mealText);
                                    });
                                }
                            }
                        });
                    }
                } else {
                    section.querySelectorAll('.meal-table tbody tr').forEach(row => {
                        const mealDescElement = row.querySelector('td:first-child strong');
                        if (mealDescElement) meals.add(mealDescElement.textContent.trim());
                    });
                    section.querySelectorAll('.mobile-meal-card .mobile-meal-description').forEach(card => {
                        const strongDesc = card.querySelector('strong');
                        let mealText = '';
                        if (strongDesc) {
                            mealText = strongDesc.textContent.trim();
                        } else {
                            let tempText = '';
                            for (const childNode of card.childNodes) {
                                if (childNode.nodeType === Node.TEXT_NODE) {
                                    tempText += childNode.textContent.trim() + ' ';
                                } else if (childNode.nodeType === Node.ELEMENT_NODE && childNode.tagName === 'STRONG') {
                                    tempText += childNode.textContent.trim() + ' ';
                                } else if (childNode.nodeType === Node.ELEMENT_NODE && (childNode.classList.contains('food-markings-row') || childNode.classList.contains('action-buttons'))) {
                                    break; 
                                }
                            }
                            mealText = tempText.trim();
                        }
                        if (mealText && mealText.length > 5) { 
                           meals.add(mealText);
                        }
                    });
                }
                break; 
            }
        }
        if (!mensaFound && (mensaName === 'Mensa Garbsen' || mensaName === 'XXXLutz Hesse Markrestaurant')) {
             console.warn(`Mensa section "${mensaName}" not found for meal collection.`);
        }
        return Array.from(meals); 
    }

    // Marvin Recommendation Trigger (only Mensa Garbsen)
    const marvinEmojiTrigger = document.getElementById('askMarvinEmojiTrigger');
    if (marvinEmojiTrigger && recommendationModal) {
        marvinEmojiTrigger.addEventListener('click', function () {
            const loadingMessage = '<i class="fas fa-spinner fa-spin"></i> Marvin verarbeitet die Sinnlosigkeit deiner Anfrage...';
            showRecommendationPopup("Marvin\'s Deprimierende Einsicht", loadingMessage, '/static/img/marvin.jpg');

            const garbsenMeals = getMealsFromMensaSection('Mensa Garbsen');

            if (garbsenMeals.length === 0) {
                showRecommendationPopup("Marvin\'s Antwort", "Es gibt nichts zu bewerten. Ein seltener Moment der Bedeutungslosigkeit, selbst für Marvin.", '/static/img/marvin.jpg', true);
                return;
            }

            fetch('/api/get_marvin_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meals: garbsenMeals })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.recommendation) {
                    showRecommendationPopup("Marvin\'s Deprimierende Einsicht", data.recommendation, '/static/img/marvin.jpg');
                } else {
                    throw new Error(data.error || "Unbekannter Fehler von Marvin.");
                }
            })
            .catch(error => {
                console.error('Error asking Marvin:', error);
                showRecommendationPopup("Marvin Fehler", `Selbst die Technik ist deprimierend: ${error.message}`, '/static/img/marvin.jpg', true);
            });
        });
    }


    // Dark Caner Recommendation Trigger
    const darkCanerEmojiTrigger = document.getElementById('askDarkCanerEmojiTrigger');
    if (darkCanerEmojiTrigger && recommendationModal) {
        darkCanerEmojiTrigger.addEventListener('click', function () {
            const loadingMessage = '<i class="fas fa-spinner fa-spin"></i> Yo, Dark Caner checkt die Gerichte ab, bruder...';
            showRecommendationPopup("Dark Caner\'s Gangsta Tipp", loadingMessage, '/static/img/darkcaner.png');

            const xxxLutzMealsForDarkCaner = getMealsFromMensaSection('XXXLutz Hesse Markrestaurant', true);

            if (xxxLutzMealsForDarkCaner.length === 0) {
                showRecommendationPopup("Dark Caner\'s Antwort", "Vallah bruder, hier gibt\'s nix zu checken... Keine Gerichte für meine krassen Berechnungen gefunden!", '/static/img/darkcaner.png', true);
                return;
            }

            fetch('/api/get_dark_caner_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meals: xxxLutzMealsForDarkCaner })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.recommendation) {
                    showRecommendationPopup("Dark Caner\'s Gangsta Tipp", data.recommendation, '/static/img/darkcaner.png');
                } else {
                    throw new Error(data.error || "Unbekannter Fehler von Dark Caner.");
                }
            })
            .catch(error => {
                console.error('Error asking Dark Caner:', error);
                showRecommendationPopup("Dark Caner Fehler", `Yo bruder, da ist was schiefgelaufen: ${error.message}`, '/static/img/darkcaner.png', true);
            });
        });
    }
    const trumpEmojiTrigger = document.getElementById('askTrumpEmojiTrigger');
    if (trumpEmojiTrigger && recommendationModal) {
        trumpEmojiTrigger.addEventListener('click', function () {
            const loadingMessage = '<i class="fas fa-spinner fa-spin"></i> Donald Trump analyzing Contine menu...';
            showRecommendationPopup("Trump\'s Recommendation", loadingMessage, '/static/img/trump.jpg');

            const contineMeals = getMealsFromMensaSection('Contine');
            if (contineMeals.length === 0) {
                showRecommendationPopup("Trump Error", "No Contine meals found to recommend.", '/static/img/trump.jpg', true);
                return;
            }

            fetch('/api/get_trump_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meals: contineMeals })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.recommendation) {
                    showRecommendationPopup("Donald Trump\'s Recommendation", data.recommendation, '/static/img/trump.jpg');
                } else {
                    throw new Error(data.error || "Unknown error from Trump API.");
                }
            })
            .catch(error => {
                console.error('Error asking Trump:', error);
                showRecommendationPopup("Trump Error", `Everything is just terrible: ${error.message}`, '/static/img/trump.jpg', true);
            });
        });
    }

    // Bob Recommendation Trigger
    const bobEmojiTrigger = document.getElementById('askBobEmojiTrigger');
    if (bobEmojiTrigger && recommendationModal) {
        bobEmojiTrigger.addEventListener('click', function () {
            const loadingMessage = '<i class="fas fa-spinner fa-spin"></i> Bob der Baumeister is building your recommendation...';
            showRecommendationPopup("Bob\'s Empfehlung", loadingMessage, '/static/img/bob.png');

            const hauptMeals = getMealsFromMensaSection('Hauptmensa');
            if (hauptMeals.length === 0) {
                showRecommendationPopup("Bob Fehler", "Keine Hauptmensa Gerichte gefunden.", '/static/img/bob.png', true);
                return;
            }

            fetch('/api/get_bob_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meals: hauptMeals })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.recommendation) {
                    showRecommendationPopup("Bob\'s Empfehlung", data.recommendation, '/static/img/bob.png');
                } else {
                    throw new Error(data.error || "Unbekannter Fehler von Bob.");
                }
            })
                .catch(error => {
                    console.error('Error asking Bob:', error);
                    showRecommendationPopup("Bob Fehler", `Vergiss nicht deinen Helm! ${error.message}`, '/static/img/bob.png', true);
                });
        });
    }

    // Dashboard Marvin Recommendation Trigger
    const loadMarvinBtn = document.getElementById('load-marvin-recommendation');
    if (loadMarvinBtn) {
        loadMarvinBtn.addEventListener('click', function () {
            const contentDiv = document.getElementById('marvin-recommendation-content');
            if (!contentDiv) return;

            // Show loading state
            contentDiv.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Marvin verarbeitet die Sinnlosigkeit deiner Anfrage...</p>';

            const garbsenMeals = getMealsFromMensaSection('Mensa Garbsen');
            const xxxLutzMealsForMarvin = getMealsFromMensaSection('XXXLutz Hesse Markrestaurant', true);
            const allMealsForMarvin = [...new Set([...garbsenMeals, ...xxxLutzMealsForMarvin].filter(m => m))];

            if (allMealsForMarvin.length === 0) {
                contentDiv.innerHTML = '<p class="text-danger">Es gibt nichts zu bewerten. Ein seltener Moment der Bedeutungslosigkeit, selbst für Marvin.</p>';
                return;
            }

            fetch('/api/get_marvin_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meals: allMealsForMarvin })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.recommendation) {
                    contentDiv.innerHTML = `<div class="alert alert-info">${data.recommendation.replace(/\n/g, '<br>')}</div>`;
                } else {
                    throw new Error(data.error || "Unbekannter Fehler von Marvin.");
                }
            })
            .catch(error => {
                console.error('Error asking Marvin:', error);
                contentDiv.innerHTML = `<div class="alert alert-danger">Selbst die Technik ist deprimierend: ${error.message}</div>`;
            });
        });
    }
    
    // Placeholder for existing vote script logic
    /*
    const voteControls = document.querySelectorAll('.vote-controls');
    voteControls.forEach(function(control) {
        // Ensure this part is correctly integrated with your actual voting script if it was previously in this block
    });
    */
    
    // Initialize Bootstrap Popovers for nutrient info triggers
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"].nutrient-info-trigger');
    const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, {
        container: 'body' // Attach popover to body to avoid table/card clipping issues
    }));

    // Expert Mode Toggle
    const expertModeToggleIcon = document.getElementById('expertModeToggleIcon');
    const expertModeCols = document.querySelectorAll('.expert-mode-col');
    let expertModeEnabled = localStorage.getItem('expertModeEnabled') === 'true';

    // Helper functions for color interpolation
    function hexToRgb(hex) {
        let r = 0, g = 0, b = 0;
        if (hex.length === 4) { // #RGB
            r = parseInt(hex[1] + hex[1], 16);
            g = parseInt(hex[2] + hex[2], 16);
            b = parseInt(hex[3] + hex[3], 16);
        } else if (hex.length === 7) { // #RRGGBB
            r = parseInt(hex.substring(1, 3), 16);
            g = parseInt(hex.substring(3, 5), 16);
            b = parseInt(hex.substring(5, 7), 16);
        }
        return { r, g, b };
    }

    function rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).padStart(6, '0');
    }

    function interpolateColor(colorStartHex, colorEndHex, factor) {
        // Clamp factor to [0, 1]
        const t = Math.max(0, Math.min(1, factor));

        const rgbStart = hexToRgb(colorStartHex);
        const rgbEnd = hexToRgb(colorEndHex);

        const r = Math.round(rgbStart.r + t * (rgbEnd.r - rgbStart.r));
        const g = Math.round(rgbStart.g + t * (rgbEnd.g - rgbStart.g));
        const b = Math.round(rgbStart.b + t * (rgbEnd.b - rgbStart.b));

        return rgbToHex(r, g, b);
    }

    function applyExpertModeStyles() {
        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
        let colorNegative, colorPositive, colorCenter;

        if (isDarkMode) {
            colorNegative = '#ff5555'; // Dark mode Downvote Red
            colorCenter = '#FFB86C';   // Dark mode Center Yellow/Orange
            colorPositive = '#50fa7b'; // Dark mode Upvote Green
        } else {
            colorNegative = '#dc3545'; // Light mode Downvote Red
            colorCenter = '#ffcc00';   // Light mode Center Yellow
            colorPositive = '#28a745'; // Light mode Upvote Green
        }

        expertModeCols.forEach(col => {
            if (col.tagName === 'TH' || col.tagName === 'TD') {
                col.style.display = expertModeEnabled ? 'table-cell' : 'none';
            } else { // For mobile view elements (divs behaving as rows/items)
                col.style.display = expertModeEnabled ? 'flex' : 'none';
            }
        });
        if (expertModeToggleIcon) {
            expertModeToggleIcon.style.opacity = expertModeEnabled ? '1' : '0.5';
        }

        const canerElements = document.querySelectorAll('.caner-symbols');
        const rkrElements = document.querySelectorAll('strong.rkr-value');
        const mpsElements = document.querySelectorAll('strong.mps-value');

        if (expertModeEnabled) {
            canerElements.forEach(el => {
                const canerValueText = el.dataset.canerValue;
                if (canerValueText === undefined) return;

                const canerValue = parseFloat(canerValueText);
                if (!isNaN(canerValue)) {
                    const scaleMaxCaner = 600; // Max value for pure positive color
                    let finalColor;
                    const visualMidPointCaner = scaleMaxCaner / 2; // Midpoint for color transition

                    if (canerValue <= 0) {
                        finalColor = colorNegative;
                    } else if (canerValue >= scaleMaxCaner) {
                        finalColor = colorPositive;
                    } else if (canerValue <= visualMidPointCaner) {
                        // Interpolate from colorNegative (at 0) to colorCenter (at visualMidPointCaner)
                        const factor = canerValue / visualMidPointCaner;
                        finalColor = interpolateColor(colorNegative, colorCenter, factor);
                    } else {
                        // Interpolate from colorCenter (at visualMidPointCaner) to colorPositive (at scaleMaxCaner)
                        const factor = (canerValue - visualMidPointCaner) / (scaleMaxCaner - visualMidPointCaner);
                        finalColor = interpolateColor(colorCenter, colorPositive, factor);
                    }
                    el.style.color = finalColor;
                }
            });

            rkrElements.forEach(el => {
                const textValue = el.textContent.replace(',', '.').replace(/[^\d.-]/g, '');
                const rkrValue = parseFloat(textValue);

                if (!isNaN(rkrValue)) {
                    const scaleMaxRkr = 20; // Max value for pure positive color
                    let finalColor;
                    const visualMidPointRkr = scaleMaxRkr / 2; // Midpoint for color transition

                    if (rkrValue <= 0) {
                        finalColor = colorNegative;
                    } else if (rkrValue >= scaleMaxRkr) {
                        finalColor = colorPositive;
                    } else if (rkrValue <= visualMidPointRkr) {
                        // Interpolate from colorNegative (at 0) to colorCenter (at visualMidPointRkr)
                        const factor = rkrValue / visualMidPointRkr;
                        finalColor = interpolateColor(colorNegative, colorCenter, factor);
                    } else {
                        // Interpolate from colorCenter (at visualMidPointRkr) to colorPositive (at scaleMaxRkr)
                        const factor = (rkrValue - visualMidPointRkr) / (scaleMaxRkr - visualMidPointRkr);
                        finalColor = interpolateColor(colorCenter, colorPositive, factor);
                    }
                    el.style.color = finalColor;
                }
            });

            mpsElements.forEach(el => {
                const textValue = el.textContent.replace(',', '.').replace(/[^\d.-]/g, '');
                const mpsValue = parseFloat(textValue);

                if (!isNaN(mpsValue)) {
                    const scaleMaxMps = 100; // Max value for pure positive color (0-100 scale)
                    let finalColor;
                    const visualMidPointMps = scaleMaxMps / 2; // Midpoint for color transition

                    if (mpsValue <= 0) {
                        finalColor = colorNegative;
                    } else if (mpsValue >= scaleMaxMps) {
                        finalColor = colorPositive;
                    } else if (mpsValue <= visualMidPointMps) {
                        // Interpolate from colorNegative (at 0) to colorCenter (at visualMidPointMps)
                        const factor = mpsValue / visualMidPointMps;
                        finalColor = interpolateColor(colorNegative, colorCenter, factor);
                    } else {
                        // Interpolate from colorCenter (at visualMidPointMps) to colorPositive (at scaleMaxMps)
                        const factor = (mpsValue - visualMidPointMps) / (scaleMaxMps - visualMidPointMps);
                        finalColor = interpolateColor(colorCenter, colorPositive, factor);
                    }
                    el.style.color = finalColor;
                }
            });

        } else { // Expert mode disabled
            canerElements.forEach(el => {
                el.style.color = ''; // Reset color
            });
            rkrElements.forEach(el => {
                el.style.color = ''; // Reset color
            });
            mpsElements.forEach(el => {
                el.style.color = ''; // Reset color
            });
        }
    }

    if (expertModeToggleIcon) {
        applyExpertModeStyles(); // Apply initial state on load

        expertModeToggleIcon.addEventListener('click', function() {
            expertModeEnabled = !expertModeEnabled; // Toggle the state
            localStorage.setItem('expertModeEnabled', expertModeEnabled);
            applyExpertModeStyles();
        });
    }

    // New code for date navigation arrows
    const mensaSelectForArrows = document.getElementById('mensa'); // Keep this for Mensa value
    const datePickerInputForArrows = document.getElementById('date'); // This is now the input for the datepicker

    // availableDatesStrings is defined below for the datepicker, ensure it's accessible here or redefined.
    // For safety, let's ensure availableDatesStrings is defined before it's used by arrow functions.
    const allAvailableDatesForArrows = [{% for date_str in available_dates %}"{{ date_str }}"{% if not loop.last %}, {% endif %}{% endfor %}];

    document.querySelectorAll('.date-nav-arrow').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            if (this.classList.contains('disabled')) {
                return;
            }

            const direction = this.dataset.direction === 'prev' ? -1 : 1;
            
            if (!datePickerInputForArrows || !mensaSelectForArrows) {
                console.error("Date input or Mensa select not found for arrow navigation.");
                return;
            }

            const currentSelectedMensa = mensaSelectForArrows.value;
            const currentSelectedDate = datePickerInputForArrows.value; // Value from the datepicker input
            
            const currentIndex = allAvailableDatesForArrows.indexOf(currentSelectedDate);

            if (currentIndex === -1) {
                console.error('Current selected date not found in available dates for arrow navigation:', currentSelectedDate, allAvailableDatesForArrows);
                return;
            }

            let newIndex = currentIndex + direction;

            // Ensure newIndex is within bounds
            if (newIndex < 0) {
                newIndex = 0;
            } else if (newIndex >= allAvailableDatesForArrows.length) {
                newIndex = allAvailableDatesForArrows.length - 1;
            }
            
            const newDate = allAvailableDatesForArrows[newIndex];

            if (newDate && newDate !== currentSelectedDate) { // Only navigate if date actually changes
                const baseUrl = window.location.pathname; 
                const params = new URLSearchParams(window.location.search); 
                params.set('date', newDate);
                params.set('mensa', currentSelectedMensa); 
                
                window.location.href = `${baseUrl}?${params.toString()}`;
            }
        });
    });

    function updateMensaTitleArrowStates() {
        if (!datePickerInputForArrows || allAvailableDatesForArrows.length === 0) return;

        const currentSelectedDate = datePickerInputForArrows.value;
        const currentIndex = allAvailableDatesForArrows.indexOf(currentSelectedDate);

        let onFirst = false;
        let onLast = false;
        
        if (currentIndex === -1) { // Should not happen if datepicker enforces selection from available dates
            onFirst = true; // Disable both if current date is somehow not in the list
            onLast = true;
        } else if (allAvailableDatesForArrows.length <= 1) { // Only one or no dates
            onFirst = true;
            onLast = true;
        } else {
            onFirst = (currentIndex === 0);
            onLast = (currentIndex === allAvailableDatesForArrows.length - 1);
        }

        document.querySelectorAll('.date-nav-arrow[data-direction="prev"]').forEach(btn => {
            btn.classList.toggle('disabled', onFirst);
            btn.setAttribute('aria-disabled', onFirst ? 'true' : 'false');
        });
        document.querySelectorAll('.date-nav-arrow[data-direction="next"]').forEach(btn => {
            btn.classList.toggle('disabled', onLast);
            btn.setAttribute('aria-disabled', onLast ? 'true' : 'false');
        });
    }

    // Call initially and potentially after date changes (though page reloads anyway for arrows)
    updateMensaTitleArrowStates();

    // Initialize Vanilla JS Datepicker
    const datepickerEl = document.getElementById('date'); // This is the same as datePickerInputForArrows
    if (datepickerEl) {
        const availableDatesStrings = [{% for date_str in available_dates %}"{{ date_str }}"{% if not loop.last %}, {% endif %}{% endfor %}];
        
        // Convert available date strings to a Set of UTC timestamps for efficient lookup
        const availableUtcTimestamps = new Set();
        availableDatesStrings.forEach(dateStr => {
            const parts = dateStr.split('.'); // dd.mm.yyyy
            if (parts.length === 3) {
                // Create a UTC date to match how the datepicker\'s filter function receives dates
                const utcDate = new Date(Date.UTC(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])));
                availableUtcTimestamps.add(utcDate.getTime());
            }
        });

        const datepicker = new Datepicker(datepickerEl, {
            format: 'dd.mm.yyyy',
            language: 'de',
            autohide: true,
            todayHighlight: false, // Disabled to prevent incorrect highlighting of multiple days
            buttonClass: 'btn', // Ensures Bootstrap buttons for prev/next in calendar
            // pickLevel: 0, // Can be 0 (days), 1 (months), 2 (years)
            filter: (dateToFilter) => {
                // dateToFilter is a Date object, typically midnight UTC for the given day.
                // We need to check if its timestamp exists in our set of available UTC timestamps.
                return availableUtcTimestamps.has(dateToFilter.getTime());
            }
        });

        datepickerEl.addEventListener('changeDate', function(event) {
            const dateValue = datepickerEl.value;
            const mensaValue = document.getElementById('mensa').value;
            const params = new URLSearchParams();
            params.set('date', dateValue);
            params.set('mensa', mensaValue);
            window.location.href = `/?${params.toString()}`;
        });

        // To ensure the arrows update if the initial date is edge case/not in list
        // which shouldn't happen if server correctly sets selected_date from available_dates
        updateMensaTitleArrowStates();

    } else {
        console.error("Datepicker input element not found.")
    }

});
</script>
{% endblock %}
